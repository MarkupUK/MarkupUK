
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xhtml="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Using XSpec to test iXML</title><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><link rel="home" href="oxygen-main.html" title="Markup UK 2025 Proceedings" /><link rel="up" href="xspec.html" title="XSpec" /><link rel="prev" href="xspec-for-xslt.html" title="Using XSpec to test XSLT" /><link rel="next" href="revelations.html" title="What testing revealed" /><!--  Generated with Oxygen version 24.0, build number 2022011710.  --><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><script type="text/javascript" xml:space="preserve"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-3.5.1.min.js" xml:space="preserve"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js" xml:space="preserve"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js" xml:space="preserve"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js?buildId=2022011710" xml:space="preserve"><!----></script></head><body onload="highlightSearchTerm()" class="frmBody"><div class="navheader"><table width="100%" summary="Navigation header"><tr><td colspan="3" rowspan="1"><form name="searchForm" id="searchForm" action="javascript:void(0)" onsubmit="parent.tocwin.SearchToc(this);" method="get" enctype="application/x-www-form-urlencoded"><!----><input type="text" id="textToSearch" name="textToSearch" class="textToSearch" size="30" placeholder="Search" /><!----></form></td></tr><tr><td width="20%" align="left" rowspan="1" colspan="1"><span class="navprev"><a accesskey="p" href="xspec-for-xslt.html" shape="rect">Prev</a></span> </td><th width="60%" align="center" rowspan="1" colspan="1"> </th><td width="20%" align="right" rowspan="1" colspan="1"> <span class="navnext"><a accesskey="n" href="revelations.html" shape="rect">Next</a></span></td></tr></table><hr /></div><div class="section" id="xspec-for-ixml"><div class="titlepage"><div><div><h4 class="title">Using XSpec to test iXML</h4></div></div></div><p>One of the maintainers of XSpec, Amanda Galtman, has identified a relatively simple way that this can be done using the <code class="code">invisible-xml</code> function in XPath 4.0[<a class="citation" href="references.html#d5e803" shape="rect"><span class="citation">GALMED</span></a>][<a class="citation" href="references.html#d5e813" shape="rect"><span class="citation">XPATH4</span></a>]. Unfortunately, the specification for XPath 4.0 is still in development and not yet widely supported. However, Amanda’s solution can already be used if you write your XSpec tests as XQuery and run them in BaseX with the Markup Blitz library. Once the <code class="code">invisible-xml</code> function is supported in an XSLT processor, it should also be possible to use it in XSpec tests written for XSLT.</p><p>When I started thinking about how XSpec’s XSLT process might be adapted for testing iXML, the main differences that I identified were:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>the context is text, not XML</p></li><li class="listitem"><p>the code being tested is an iXML grammar, not an XSLT stylesheet</p></li></ol></div><p>I wanted to make as few changes as possible to the way that the XSpec test file would be written[<a class="citation" href="references.html#d5e818" shape="rect"><span class="citation">WRITEXSPEC</span></a>] and realised that this would be possible if I could apply the iXML transformation to the context before the expectations were evaluated. So that the XSpec would be able to easily differentiate a test file written for iXML from one written for XSLT, XQuery or Schematron, I added a new attribute to the root element of the test file, named <code class="code">grammar</code>, the value of which is expected to be a path to a file containing the iXML grammar being tested.</p><div class="figure" id="xspec-xml-for-ixml"><p class="title"><strong>Figure 7. An example of an XSpec test file for iXML</strong></p><div class="figure-contents"><div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td rowspan="1" colspan="1"><img src="papers-2025/02-thomson/images/changes_for_ixml.png" width="100%" alt="An example of an XSpec test file for iXML" /></td></tr></table></div></div></div><br class="figure-break" clear="none" /><p>In <a class="xref" href="xspec-for-ixml.html#xspec-xml-for-ixml" title="Figure 7. An example of an XSpec test file for iXML" shape="rect">Figure 7, “An example of an XSpec test file for iXML”</a>, the iXML grammar is specified on line 3 and the text to be converted to XML is stored in a separate file and specified using the <code class="code">href</code> attribute on <code class="code">x:context</code> (line 7). This is a standard option in XSpec that’s very useful if you’re re-using the same text in multiple scenarios. The contents of <code class="filename">xhtml_public_path.txt</code> can be seen in <a class="xref" href="learning-ixml.html#doctype-declaration-example" title="Figure 3. Single-line text file containing a DOCTYPE declaration for XHTML" shape="rect">Figure 3, “Single-line text file containing a DOCTYPE declaration for XHTML”</a>. The expected result is specified, as per usual, via the <code class="code">x:expect</code> element (lines 9-16). Similar though it is, this test file is not a valid XSpec file so I also changed the namespace URI (line 2). During the iXML pre-processing step, when a valid XSpec file is created, the namespace URI is changed back to <code class="code">http://www.jenitennison.com/xslt/xspec</code>.</p><p>Under the hood of the XSpec testing process, there are four main steps: compile, evaluate, report and summarise.</p><div class="figure" id="xspec-standard-steps"><p class="title"><strong>Figure 8. Steps in the XSpec process, with inputs and outputs</strong></p><div class="figure-contents"><div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td rowspan="1" colspan="1"><img src="papers-2025/02-thomson/images/xspec_stages_of_processing.drawio.png" width="100%" alt="Steps in the XSpec process, with inputs and outputs" /></td></tr></table></div></div></div><br class="figure-break" clear="none" /><p>I decided to add the iXML transformation as an extra step, immediately before Compile; it’s not unprecedented, as XSpec already includes a pre-processing step when testing Schematron. I implemented this step using XProc, mostly so that I could take advantage of its support for iXML (<code class="code">p:ixml</code><a href="#ftn.d5e629" class="footnote" shape="rect"><sup class="footnote" id="d5e629">[2]</sup></a>)[<a class="citation" href="references.html#d5e823" shape="rect"><span class="citation">XPROCIXML</span></a>] but also, if I’m honest, in part because it was a personal project and I enjoy working with XProc. This custom XProc step:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>changes the namespace URI from <code class="code">http://xylarium.org/ns/xspec/utils/ixspec</code> to <code class="code">http://www.jenitennison.com/xslt/xspec</code></p></li><li class="listitem"><p>replaces <code class="code">/x:description/@grammar</code> with <code class="code">/x:description/@stylesheet</code> which references an XSLT identity transform stylesheet</p></li><li class="listitem"><p>uses <code class="code">p:viewport</code> to iterate over all the <code class="code">x:context</code> elements and, for each:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p>uses <code class="code">p:ixml</code> to transform the input (<code class="code">x:context/@href</code>) into XML using the grammar (<code class="code">/x:description/@grammar</code>) and stores the result as a temporary file</p></li><li class="listitem"><p>changes <code class="code">x:context/@href</code> to reference the temporary file containing the result of the iXML transformation</p></li></ol></div></li><li class="listitem"><p>uses <code class="code">resolve-uri()</code> and <code class="code">p:xslt</code> to change any <code class="code">x:expect/@href</code> URIs that are relative to absolute.</p></li></ol></div><p><a class="xref" href="xspec-for-ixml.html#xspec-for-ixml-preprocessed" title="Figure 9. XSpec test file for iXML after pre-processing" shape="rect">Figure 9, “XSpec test file for iXML after pre-processing”</a>, shows what the output of this step would be if it were applied to the example XSpec file shown in <a class="xref" href="xspec-for-ixml.html#xspec-xml-for-ixml" title="Figure 7. An example of an XSpec test file for iXML" shape="rect">Figure 7, “An example of an XSpec test file for iXML”</a>.</p><div class="figure" id="xspec-for-ixml-preprocessed"><p class="title"><strong>Figure 9. XSpec test file for iXML after pre-processing</strong></p><div class="figure-contents"><div class="mediaobject"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;" width="100%"><tr><td rowspan="1" colspan="1"><img src="papers-2025/02-thomson/images/changes_for_ixspec_preprocessed.png" width="100%" alt="XSpec test file for iXML after pre-processing" /></td></tr></table></div></div></div><br class="figure-break" clear="none" /><p>If the iXML grammar is correct then the contents of <code class="filename">1.ixml-output.xml</code> (the results of the iXML transformation) will now be the same as the contents of the <code class="code">x:expect</code> element in Figure 7. This (temporary) XSpec file can now progress through the normal XSpec steps: compile, evaluate, report and summarise. If the result of the iXML transformation isn’t as expected then the differences will be displayed side-by-side in XSpec’s HTML report.</p><div class="footnotes"><br clear="none" /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.d5e629" class="footnote"><p><a href="#d5e629" class="para" shape="rect"><sup class="para">[2] </sup></a>The name of this function has since changed to <code class="code">p:invisible-xml</code>[<a class="citation" href="references.html#d5e823" shape="rect"><span class="citation">XPROCIXML</span></a>]</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left" rowspan="1" colspan="1"><span class="navprev"><a accesskey="p" href="xspec-for-xslt.html" shape="rect">Prev</a></span> </td><td width="20%" align="center" rowspan="1" colspan="1"><a accesskey="u" href="xspec.html" shape="rect">Up</a></td><td width="40%" align="right" rowspan="1" colspan="1"> <span class="navnext"><a accesskey="n" href="revelations.html" shape="rect">Next</a></span></td></tr><tr><td width="40%" align="left" valign="top" rowspan="1" colspan="1"> </td><td width="20%" align="center" rowspan="1" colspan="1"><a accesskey="h" href="oxygen-main.html" shape="rect">Home</a></td><td width="40%" align="right" valign="top" rowspan="1" colspan="1"> </td></tr></table></div><div class="footer">Generated by<a class="oxyFooter" href="http://www.oxygenxml.com/xml_webhelp.html" target="_blank" shape="rect">                            
                            &lt;oXygen/&gt; XML WebHelp
                        </a></div></body></html>